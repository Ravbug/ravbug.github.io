<head>
    <title>WebPhoto</title>
    <meta name="description" content="Non-destructive image editing using CSS filters">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link id="favicon" rel="icon" href="https://avatars2.githubusercontent.com/u/22283943" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="../bootstrap-custom.css">
    <link rel="stylesheet" type="text/css" href="../stylesheet.css">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<style id="delbtns">
    #delbtn{
        display:none;
    }
    #orderbtngroup{
        display:unset;
    }
</style>
<div class=main-view>
    <div>
            <b>Image URL:</b><input id="img-url"><button onclick="loadurl()">Load</button>
            <button onmousedown="renderview.style.filter=''" onmouseup="render(this)">Show Original</button>
            <button onclick="downloadEdit()">Download Edit Doc</button>
            <button onclick="downloadPreset()">Download Preset</button>
            <button onclick="filePicker.click()">Import Edit Doc</button>
            <input type="file" style="display:none;" id="inputfile"/>
    </div>
    <div class=view>
        <div id="render">
            <img id="image" class="center" src="https://wallpapercave.com/wp/YHSuCPt.jpg">
        </div>
        <div class=controls id="controlframe">
            <button onclick="addAdjustmentGroup()">Add Adjustment Group</button>
            <button onclick="toggleDelete(this)">Del</button>
        </div>
        
    </div>
    
</div>

<!-- Built in SVG filters -->
<svg id=svg_builtin>
    <filter id="GaussianBlur10">
       <feGaussianBlur stdDeviation="10"/>
    </filter>
    <filter id="LumaToAlpha">
        <feColorMatrix in="SourceGraphic" type="luminanceToAlpha" />
    </filter>
    <filter id="turbulence">
        <feTurbulence type="turbulence" baseFrequency="0.01" numOctaves="10" result="turbulence"/>
        <feDisplacementMap in2="turbulence" in="SourceGraphic" scale="50" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
    <filter id="erode">
        <feMorphology operator="erode" radius="1"/>
    </filter>
    <filter id="dilate">
        <feMorphology operator="dilate" radius="2"/>
    </filter>
    <filter id="RedBlueSwap">    
        <feColorMatrix type="matrix" values="0 0 0 1 0
        0 1 0 0 0
        1 0 0 0 0
        0 0 0 500 -20" x="0%" y="0%" width="100%" height="100%" in="SourceGraphic"/>
    </filter>
    <filter id="BrightBW">
        <feColorMatrix type="matrix" values="0.7 0.7 0.7 0 0
            0.7 0.7 0.7 0 0
            0.7 0.7 0.7 0 0
            0 0 0 500 -20" x="0%" y="0%" width="100%" height="100%" in="SourceGraphic" >
        </feColorMatrix>
    </filter>
    <filter id="Blot" x="-20%" y="-20%" width="140%" height="140%" filterUnits="objectBoundingBox" primitiveUnits="userSpaceOnUse" color-interpolation-filters="linearRGB">
        <feDisplacementMap in="SourceGraphic" in2="SourceGraphic" scale="20" xChannelSelector="R" yChannelSelector="B" x="0%" y="0%" width="100%" height="100%" result="displacementMap"/>
        <feMorphology operator="erode" radius="3 3" x="0%" y="0%" width="100%" height="100%" in="displacementMap" result="morphology"/>
    </filter>
</svg>

<script src="webphoto.js"></script>
<script src="../utilities.js"></script>
<script>
    let delmode = false;
    function loadurl(){
        let url = document.getElementById("img-url").value;
        document.getElementById("imgdata").href.baseVal=url;
    }
    function toggleDelete(btn){
        delmode = !delmode
        btn.innerHTML = delmode? "Done" : "Del";
        document.getElementById("delbtns").innerHTML = `
        #delbtn{
            display:${delmode? "unset" :"none"};
        }
        #orderbtngroup{
            display:${!delmode? "unset" :"none"};
        }
        `;
    }
    function downloadEdit(){
        let name;
        if (name = prompt("Name file","adjustments")){
            dlEditDoc(name,true);
        }
    }
    function downloadPreset(){
        let name;
        if (name = prompt("Name file","preset")){
            dlEditDoc(name,false);
        }
    }
    let filePicker = document.getElementById('inputfile');

    //when a file is uploaded
    filePicker.onchange = function(){
        const reader = new FileReader();
        reader.onload = function(e){
            let doc = JSON.parse(e.target.result);
            //load the image if the file describes one
            if (doc["img"]){
                document.getElementById("imgdata").href.baseVal = doc["img"]
            }
            //clear the adjustment sidebar
            {
                let elements = document.getElementsByTagName("adjgroup");
                for (let element of elements){
                    element.remove();
                }
            }
            order = [];

            //add adjustment groups
            for(let group of doc["adj"]){
                let g = addAdjustmentGroup();
                g.enable.checked = group["on"];
                //add adjustments and set their values
                for (let adjustment of group["adj"]){
                    let a = addAdjustment(adjustment["name"],g);
                    a.setvalue(adjustment["val"]);
                    a.enable.checked = adjustment["on"]
                }
            }
            render();
        }
        reader.readAsText(filePicker.files[0]);
    }
    //start with one adustment group
    addAdjustmentGroup();
    render();
</script>