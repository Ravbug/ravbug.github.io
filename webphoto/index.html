<head>
    <title>WebPhoto</title>
    <meta name="description" content="Non-destructive image editing using CSS filters">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link id="favicon" rel="icon" href="icon.svg" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="../bootstrap-custom.css">
    <link rel="stylesheet" type="text/css" href="../stylesheet.css">
    <link rel="stylesheet" type="text/css" href="style.css">

    <!-- Social embed image -->
    <meta property="og:image" content="https://ravbug.github.io/webphoto/icon.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1024">
</head>

<style id="delbtns">
    #delbtn{
        display:none;
    }
    #orderbtngroup{
        display:unset;
    }
</style>
<div class=main-view>
    <div>
            <b>Image URL:</b><input id="img-url"><button onclick="loadurl()">Load</button>
            <button onmousedown="renderview.style.filter=''" onmouseup="render(this)">Show Original</button>
            <button onclick="downloadEdit()">Download Edit Doc</button>
            <button onclick="downloadPreset()">Download Preset</button>
            <button onclick="filePicker.click()">Import Edit Doc</button>
            <input type="file" style="display:none;" id="inputfile"/>
    </div>
    <div class=view>
        <div id="render">
            <img id="image" class="center" src="https://wallpapercave.com/wp/YHSuCPt.jpg">
        </div>
        <div class=controls id="controlframe">
            <button onclick="addAdjustmentGroup()">Add Adjustment Group</button>
            <button onclick="toggleDelete(this)">Del</button>
        </div>
        
    </div>
    
</div>

<!-- Built in SVG filters -->
<svg id=svg_builtin>
    <filter id="GaussianBlur1">
        <feGaussianBlur stdDeviation="1" x="0%" y="0%" width="100%" height="100%" in="SourceGraphic" edgeMode="wrap"/>
    </filter>
    <filter id="GaussianBlur3">
        <feGaussianBlur stdDeviation="3" x="0%" y="0%" width="100%" height="100%" in="SourceGraphic" edgeMode="wrap"/>
    </filter>
    <filter id="GaussianBlur10">
        <feGaussianBlur stdDeviation="10" x="0%" y="0%" width="100%" height="100%" in="SourceGraphic" edgeMode="wrap"/>
    </filter>
    <filter id="GaussianBlur50">
        <feGaussianBlur stdDeviation="50" x="0%" y="0%" width="100%" height="100%" in="SourceGraphic" edgeMode="wrap"/>
    </filter>
    <filter id="LumaToAlpha">
        <feColorMatrix in="SourceGraphic" type="luminanceToAlpha" />
    </filter>
    <filter id="turbulence">
        <feTurbulence type="turbulence" baseFrequency="0.01" numOctaves="10" result="turbulence"/>
        <feDisplacementMap in2="turbulence" in="SourceGraphic" scale="50" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
    <filter id="erode">
        <feMorphology operator="erode" radius="1"/>
    </filter>
    <filter id="dilate">
        <feMorphology operator="dilate" radius="2"/>
    </filter>
    <filter id="RedBlueSwap">    
        <feColorMatrix type="matrix" values="0 0 0 1 0
        0 1 0 0 0
        1 0 0 0 0
        0 0 0 500 -20" x="0%" y="0%" width="100%" height="100%" in="SourceGraphic"/>
    </filter>
    <filter id="BrightBW">
        <feColorMatrix type="matrix" values="0.7 0.7 0.7 0 0
            0.7 0.7 0.7 0 0
            0.7 0.7 0.7 0 0
            0 0 0 500 -20" x="0%" y="0%" width="100%" height="100%" in="SourceGraphic" >
        </feColorMatrix>
    </filter>
    <filter id="Blot" x="-20%" y="-20%" width="140%" height="140%" filterUnits="objectBoundingBox" primitiveUnits="userSpaceOnUse" color-interpolation-filters="linearRGB">
        <feDisplacementMap in="SourceGraphic" in2="SourceGraphic" scale="20" xChannelSelector="R" yChannelSelector="B" x="0%" y="0%" width="100%" height="100%" result="displacementMap"/>
        <feMorphology operator="erode" radius="3 3" x="0%" y="0%" width="100%" height="100%" in="displacementMap" result="morphology"/>
    </filter>
    <filter id="duotone">
        <feColorMatrix type="matrix" values=".33 .33 .33 0 0
                .33 .33 .33 0 0
                .33 .33 .33 0 0
                0 0 0 1 0">
        </feColorMatrix>
        <feComponentTransfer color-interpolation-filters="sRGB">
            <feFuncR type="table" tableValues=".996078431  .984313725"></feFuncR>
            <feFuncG type="table" tableValues=".125490196  .941176471"></feFuncG>
            <feFuncB type="table" tableValues=".552941176  .478431373"></feFuncB>
        </feComponentTransfer>
    </filter>
    <filter id="posterize">
        <feComponentTransfer>
              <feFuncR type="discrete" tableValues=".25 .4 .5 .75 1"/>
              <feFuncG type="discrete" tableValues=".25 .4 .5 .75 1"/>
              <feFuncB type="discrete" tableValues=".25 .4 .5 .75 1"/>
          </feComponentTransfer>
    </filter>
</svg>
<svg id="svg_user">

</svg>

<script src="webphoto.js"></script>
<script src="../utilities.js"></script>
<script>
    let delmode = false;
    function loadurl(){
        let url = document.getElementById("img-url").value;
        document.getElementById("imgdata").href.baseVal=url;
    }
    function toggleDelete(btn){
        delmode = !delmode
        btn.innerHTML = delmode? "Done" : "Del";
        document.getElementById("delbtns").innerHTML = `
        #delbtn{
            display:${delmode? "unset" :"none"};
        }
        #orderbtngroup{
            display:${!delmode? "unset" :"none"};
        }
        `;
    }
    function downloadEdit(){
        let name;
        if (name = prompt("Name file","adjustments")){
            dlEditDoc(name,true);
        }
    }
    function downloadPreset(){
        let name;
        if (name = prompt("Name file","preset")){
            dlEditDoc(name,false);
        }
    }
    let filePicker = document.getElementById('inputfile');

    //when a file is uploaded
    filePicker.onchange = function(){
        const reader = new FileReader();
        reader.onload = function(e){
            let doc = JSON.parse(e.target.result);
            //load the image if the file describes one
            if (doc["img"]){
                document.getElementById("imgdata").href.baseVal = doc["img"]
            }

            //load custom SVG filters
            svgelem.innerHTML = doc["filters"];
            let usr_filters = svgelem.getElementsByTagName("filter");
            for (let f of usr_filters){
                svgfilters.add(f.id);
            }

            //clear the adjustment sidebar
            {
                let elements = document.getElementsByTagName("adjgroup");
                for (let element of elements){
                    element.remove();
                }
            }
            order = [];

            //add adjustment groups
            for(let group of doc["adj"]){
                let g = addAdjustmentGroup();
                g.enable.checked = group["on"];
                //add adjustments and set their values
                for (let adjustment of group["adj"]){
                    let a = addAdjustment(adjustment["name"],g);
                    a.enable.checked = adjustment["on"];
                    if (adjustment.name == "svg"){
                        a.select.innerHTML = `<option>${adjustment["val"]}</option>`;
                    }
                    else{
                        a.setvalue(adjustment["val"]);    
                    }
                }
            }
            render();
        }
        reader.readAsText(filePicker.files[0]);
    }
    //start with one adustment group
    addAdjustmentGroup();
    render();
</script>