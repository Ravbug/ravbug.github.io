<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../stylesheet.css">
    <title>YouTube Audio Player</title>
</head>
<style>
    .player,
    .volume {
        display: grid;
        text-align: center;
    }

    .player {
        grid-template-columns: 40px 1fr 130px 150px;
        gap: 10px;
        border-radius: 40px;
        box-shadow: 2px 2px 5px #CCC;
        padding: 10px;
        align-items: center;
    }

    .volume {
        padding: 5px;
        grid-template-columns: 40px 1fr;
    }
    #ytplayer{
        display:none;
    }
</style>

<div class="main">
    <div id="name">Now Playing: </div>
    <div class="player">
        <button id='playpause' onclick="togglePlay(this)">‚ñ∂</button>
        <input id="playhead" type="range" value=0 min=0 step=1 onmousedown="player.pauseVideo()" onmouseup="player.playVideo()" oninput="updateReadout()" onchange="player.seekTo(this.value)"></input>
        <div id="time">00:00:00 / 00:00:00</div>
        <div class="volume">
            <button id="muteBtn" onclick="toggleMute(this)">üîà</button>
            <input id="volslider" type="range" min=1 max=100 oninput="changeVolume(this.value)"></input>
        </div>
    </div>
    <br>
    <div> 
        <form onsubmit="let v = document.getElementById('addvid'); loadVideo(v.value); v.value=''; return false">
            Load Video: <input id="addvid"></input>
        </form>        
        <form onsubmit="let v = document.getElementById('addpl'); loadPlaylist(v.value);v.value='';return false">
            Load Playlist:<input id="addpl"></input>
        </form>
    </div>
</div>

<div id="ytplayer"></div>

<script src="https://www.youtube.com/player_api"></script>
<script src="../utilities.js"></script>
<script>
  let playpause = document.getElementById('playpause')
  let playhead = document.getElementById('playhead');
  let time = document.getElementById("time");
  let volslider = document.getElementById("volslider");
  let nameFieled = document.getElementById('name');

  let startVidId = "";
  let startPlId = "";
  let startplidx = 0;
  //read the URL arguments
  {
      let args = readURLArgs();
      let argdict = {}
      for (let arg of args){
          let parts = arg.split('=');
          argdict[parts[0]] = parts[1];
      }
      //load the initial video
      startVidId = argdict["v"];
      //load the initial playlist
      try{
        startPlId = argdict['pl'];
        startplidx = argdict['i']
      }catch(e){}
  }

  // Replace the 'ytplayer' element with an <iframe> and
  // YouTube player after the API code downloads.
  let player;
  function onYouTubePlayerAPIReady() {
    player = new YT.Player('ytplayer', {
      height: '50',
      width: '50',
      videoId: startVidId,
      events:{
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
   
  }

  function loadVideo(id){
      nameFieled.innerHTML = "Now Playing: Video " + id;
      player.loadVideoById(id);
  }

  function loadPlaylist(id){
    nameFieled.innerHTML = "Now Playing: Playlist " + id;
    player.loadPlaylist({list:id,listType:"playlist",index:startplidx})
  }

    //on player load
  function onPlayerReady(event){
    player.playVideo();
    //load playlist if one is specified
    if (startPlId!=undefined){loadPlaylist(startPlId)};
    //update volume slider
    document.getElementById("volslider").value = player.getVolume();
  }
  function onPlayerStateChange(event){
      let state = event.data;
      if (state == 1){
        playpause.innerHTML = "‚Äñ"; 
        updateReadout();
        //start slider update
        playhead.max = player.getDuration();
        playhead.value = player.getCurrentTime()
        startSliderUpdate();
      }
      if (state == 2){
        playpause.innerHTML = "‚ñ∂";
        //stop slider update
        stopSliderUpdate();
        updateReadout();
      }
      if (state == 3){
        playpause.innerHTML = '‚è≥';
      }
      if (state == 0){
          playpause.innerHTML = '‚èÆ'
          //if loop is enabled, trigger play
      }
  }
  function togglePlay(button){
      player.getPlayerState() == 1?  player.pauseVideo() :  player.playVideo(); 
  }

  function toggleMute(button){
      player.isMuted()? player.unMute() : player.mute();
      if (!player.isMuted()){
            button.innerHTML = 'üîá';
            volslider.disabled = true;
            return;
      }
      else{
        volslider.disabled = false;
        setVolIcon(button);
      }
  }

  function changeVolume(value){
    player.setVolume(value);
    setVolIcon(document.getElementById('muteBtn'));
  }

  function setVolIcon(button){
    let vol = player.getVolume();
    if (vol < 20){
        button.innerHTML = 'üîà'
    }
    else if (vol > 80){
        button.innerHTML = 'üîä';
    }
    else{
        button.innerHTML = 'üîâ'
    }
  }

  //converts seconds to time stamp
  function secToStamp(sec){
    var date = new Date(null);
    date.setSeconds(sec); 
    return date.toISOString().substr(11, 8);
  }

  function updateReadout(){
    time.innerHTML = `${secToStamp(playhead.value)} / ${secToStamp(playhead.max)}`;
  }

  var loopID = null;
  function startSliderUpdate(){
    if (loopID == null){
        loopID = setInterval(function(){
            //update slider
            playhead.value = player.getCurrentTime()
            //update readout
            updateReadout();
        },1000)
    }
  }
  function stopSliderUpdate(){
      clearTimeout(loopID);
      loopID = null;
  }
</script>