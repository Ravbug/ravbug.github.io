<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="../stylesheet.css">
  <link rel="stylesheet" href="../bootstrap-custom.css">
  <title>YouTube Audio Player</title>
</head>
<style>
  .playhead, .volume, .player, .btnrow {
    display: grid;
    text-align: center;
    align-items: center;
    gap:10px;
  }

  .box, .player {
    border-radius: 20px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    padding: 10px;
  }

  .playhead{
    grid-template-columns: 50px 65px 1fr 65px;
  }

  .player{
    grid-template-rows: 40px 40px 40px;
  }

  .btnrow{
    margin:auto;
    grid-template-columns: 50px 50px 50px;
    gap:5px;
  }

  .volume {
    grid-template-columns: 40px 1fr 40px;
    width:100%;
    max-width:250px;
    margin:auto;
  }

  #ytplayer {
    display: none;
  }

  #time,#ctime, #volLabel {
    font-family: monospace;
    font-size: 12px;
  }

  #playlist_ctrl {
    display: grid;
    grid-template-columns: repeat(auto-fill, 300px);
    width: 100%;
  }

  button {
    border-radius: 2px;
    border: 1px solid darkgray;
    background-color: white;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
  }
  button:hover {
    background-color: #EEE;
  }
  button:active {
    background-color: #DDD;
    color: black;
  }
</style>

<div class="main">
  <div id="name">Now Playing: </div>
  <div class="player">
    <div class=playhead>
        <button id='playpause' onclick="togglePlay(this)">‚ñ∂</button>
        <div id="ctime">00:00:00</div>
        <input id="playhead" type="range" value=0 min=0 step=1 onmousedown="player.pauseVideo()"
          onmouseup="player.playVideo()" oninput="updateReadout()" onchange="player.seekTo(this.value)"></input>
        <div id="time">00:00:00</div>
    </div>
    <div class=btnrow>
      <button class="externalctrl" onclick="player.previousVideo()">‚á¶</button>
      <button class="externalctrl" onclick="player.nextVideo()">‚á®</button>
      <button id="loopbtn" class="externalctrl" onclick="toggleLoop(this)">Loop</button>
    </div>
    <div class="volume">
        <button id="muteBtn" onclick="toggleMute(this)">üîà</button>
        <input id="volslider" type="range" min=1 max=100 oninput="changeVolume(this.value)"></input>
        <div id="volLabel">50%</div>
      </div>
  </div>
  <br>
  <div class="box">
    <form onsubmit="playID(); return false">
      <div class="input-group">
        <span class="input-group-addon">Load Video:</span>
        <input class="form-control" id="addvid" placeholder="Paste a video ID or URL"></input>
      </div>
    </form>
    <form onsubmit="playPlaylist();return false">
      <div class="input-group">
        <span class="input-group-addon">Load Playlist:</span>
        <input class="form-control" id="addpl" placeholder="Paste a playlist ID, URL, or video with playlist"></input>
      </div>
    </form>
    <div id="playlist_ctrl">
      <form onsubmit="jumpToVideo();return false">
        <div class="input-group">
          <span class="input-group-addon">Jump to index:</span>
          <input class="form-control" id="jumpto" type=number value=0 min=0 step=1></input>
        </div>
      </form>
      <div>
        <button class="externalctrl">Loop Pl</button>
        <button id="shufflebtn" class="externalctrl" onclick="">ShufflePL</button>
      </div>
    </div>
  </div>
</div>
</div>

<div id="ytplayer"></div>
<script>
    function offline(){
      alert("Unable to load.\nCheck your internet connection, and reload if necessary.");
    }
</script>
<script onerror="offline()" src="https://www.youtube.com/player_api"></script>
<script src="../utilities.js"></script>
<script>
  let playpause = document.getElementById('playpause')
  let playhead = document.getElementById('playhead');
  let time = document.getElementById("time");
  let ctime = document.getElementById("ctime");
  let volslider = document.getElementById("volslider");
  let nameFieled = document.getElementById('name');

  let startVidId = "";
  let startPlId = "";
  let startplidx = 0;

  //video looping, not a provided feature of embed api
  let loop = true;
  toggleLoop(document.getElementById('loopbtn'));
  //read the URL arguments
  {
    let args = readURLArgs();
    let argdict = {}
    for (let arg of args) {
      let parts = arg.split('=');
      argdict[parts[0]] = parts[1];
    }
    //load the initial video
    startVidId = argdict["v"];
    //load the initial playlist
    try {
      startPlId = YouTubeGetID(argdict['pl']);
      startplidx = getYoutubePlaylistId(argdict['i']);
    } catch (e) { }
  }

  // Replace the 'ytplayer' element with an <iframe> and
  // YouTube player after the API code downloads.
  let player;
  function onYouTubePlayerAPIReady() {
    player = new YT.Player('ytplayer', {
      height: '50',
      width: '50',
      videoId: startVidId,
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange,
        'onError': onError
      }
    });
  }

  function onError(event) {
    let status = event.data;
    if (status == 101 || status == 150) {
      //embedded playback was disabled
      playpause.innerHTML = "üîí";
      alert("The selected video cannot be played outside of YouTube.com")
    }
    if (status == 100) {
      //video cannot be loaded / found
      playpause.innerHTML = "‚ÅâÔ∏è";
      alert("The selected video could not be found")
    }
    if (status == 5) {
      //HTML5 player had an error
      playpause.innerHTML = "üõë";
      alert("The player errored. Reload the page.")
    }

    if (status == 2) {
      //Invalid parameter
      playpause.innerHTML = "‚ö†Ô∏è"
      alert("Invalid parameter")
    }
  }

  function loadVideo(id) {
    nameFieled.innerHTML = "Now Playing: Video " + id;
    player.loadVideoById(id);
  }

  function loadPlaylist(id) {
    nameFieled.innerHTML = "Now Playing: Playlist " + id;
    player.loadPlaylist({ list: id, listType: "playlist", index: startplidx })
  }

  //on player load
  function onPlayerReady(event) {
    player.playVideo();
    //load playlist if one is specified
    if (startPlId != undefined) { loadPlaylist(startPlId) };
    //update volume slider
    document.getElementById("volslider").value = player.getVolume();
  }
  function onPlayerStateChange(event) {
    let state = event.data;
    if (state == 1) {
      playpause.innerHTML = "‚Äñ";
      updateReadout();
      //start slider update
      playhead.max = player.getDuration();
      playhead.value = player.getCurrentTime()
      startSliderUpdate();
    }
    if (state == 2) {
      playpause.innerHTML = "‚ñ∂";
      //stop slider update
      stopSliderUpdate();
      updateReadout();
    }
    if (state == 3) {
      playpause.innerHTML = '‚è≥';
    }
    if (state == 0) {
      playpause.innerHTML = '‚èÆ'
      //if loop is enabled, trigger play
      if (loop) {
        player.playVideo();
      }
    }
  }
  //called when play button hit
  function togglePlay(button) {
    player.getPlayerState() == 1 ? player.pauseVideo() : player.playVideo();
  }

  //called when loop is pressed
  function toggleLoop(button) {
    loop = !loop;
    button.innerHTML = loop ? 'üîÅ' : '‚û°'
  }

  function toggleMute(button) {
    player.isMuted() ? player.unMute() : player.mute();
    if (!player.isMuted()) {
      button.innerHTML = 'üîá';
      volslider.disabled = true;
      return;
    }
    else {
      volslider.disabled = false;
      setVolIcon(button);
    }
  }

  function changeVolume(value) {
    document.getElementById("volLabel").innerHTML = `${value}%`;
    player.setVolume(value);
    setVolIcon(document.getElementById('muteBtn'));
  }

  function setVolIcon(button) {
    let vol = player.getVolume();
    if (vol < 20) {
      button.innerHTML = 'üîà'
    }
    else if (vol > 80) {
      button.innerHTML = 'üîä';
    }
    else {
      button.innerHTML = 'üîâ'
    }
  }

  //converts seconds to time stamp
  function secToStamp(sec) {
    var date = new Date(null);
    date.setSeconds(sec);
    return date.toISOString().substr(11, 8);
  }

  function updateReadout() {
    time.innerHTML = secToStamp(playhead.max);
    ctime.innerHTML= secToStamp(playhead.value);
  }

  //updating (and stopping updates) to the playhead slider
  var loopID = null;
  function startSliderUpdate() {
    if (loopID == null) {
      loopID = setInterval(function () {
        //update slider
        playhead.value = player.getCurrentTime()
        //update readout
        updateReadout();
      }, 1000)
    }
  }
  function stopSliderUpdate() {
    clearTimeout(loopID);
    loopID = null;
  }

  //called when user presses enter in Jump To video field
  function jumpToVideo() {
    try{
      player.playVideoAt(document.getElementById('jumpto').value);
    }catch(e){offline()}
  }

  //called when user presses enter in play video field
  function playID() {
    try{
      let v = document.getElementById('addvid');
      if (v.value != "") {
        loadVideo(YouTubeGetID(v.value));
        v.value = ''
      }
    }catch(e){offline()}
  }

  //called when user presses enter in playlist field
  function playPlaylist() {
    try{
      let v = document.getElementById('addpl');
      if (v.value != "") {
        loadPlaylist(getYoutubePlaylistId(v.value));
        v.value = ''
      }
    }catch(e){offline()}
  }


  /**
  * Get YouTube ID from various YouTube URL
  * @param {string} url the URL to extract
  * @attribution: https://gist.github.com/takien/4077195
  */

  function YouTubeGetID(url) {
    var ID = '';
    url = url.replace(/(>|<)/gi, '').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
    if (url[2] !== undefined) {
      ID = url[2].split(/[^0-9a-z_\-]/i);
      ID = ID[0];
    }
    else {
      ID = url;
    }
    return ID;
  }

  /**
   * Gets a YouTube PlaylistID from different YouTube URLs
   * @param {string} url the URL to extract
   * @attribution: https://github.com/pierreneter-repositories/get-youtube-playlist-id/ (adapted)
   */
  function getYoutubePlaylistId(url) {
    if (!url.includes("http")) {
      return url;
    }
    var id = /[&|\?]list=([a-zA-Z0-9_-]+)/gi.exec(url)
    return (id && id.length > 0) ? id[1] : false
  }

</script>